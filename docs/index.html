
<!DOCTYPE html>
<html>
  <head>
    <title>Duplicate Hebrew Dates</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <div class="container">
      <h1>Duplicate hebrew dates in your Google calendar</h1>
      <p>This app will let you manage hebrew dates easily, share them with others, and maintain them up to date.</p>

      <p>First, you will have to define a separate google calendar, and put in all the dates in the current hebrew year. As any google calendar, you will be able to share it with your family or friedns.</p>
      <p>Once a year you will need this app in order to duplicate the dates from the current year to the next year, preserving the hebrew dates. In order to do that:</p>
      <ul>
        <li>Press the authorize button and allow the app to access your calendars.</li>
        <li>Choose the correct calendar from the dropdown.</li>
        <li>Choose the original year containing the dates, usually current year.</li>
        <li>Choose the target year you want to populate with the dates, usually next year.</li>
        <li>Click the "Duplicate" button.</li>
        <li>That's all.</li>
      </ul>

      <p>If you want to delete the target year before, you can use the "Delete Target" button. Please use this option carfully in order to avoid event loss.</p>
      <!--Add buttons to initiate auth sequence and sign out-->
      <button id="authorize_button" class="btn btn-primary" style="display: none;">Authorize</button>
      <div id="signedin_div" style="display: none;">
        <button id="signout_button" style="display: none;">Sign Out</button>
        <div class="form-group">
          <label for="calendar_select">Choose Calendar:</label>
          <select id="calendar_select"></select>    
        </div>
        <div class="form-group">
          <label for="fromYear_select">Origin Hebrew Year:</label>
          <select id="fromYear_select"></select>
          <small id="fromYear_p"></small>
        </div>
        <div class="form-group">
          <label for="toYear_select">Targer Year:</label>
          <select id="toYear_select"></select>
          <small id="toYear_p"></small>
        </div>
        <div class="form-row">
          <button id="duplicate_button" class="btn btn-primary">Duplicate</button>
          <button id="delete_button" class="btn btn-danger">Delete Target</button>
        </div>
        <div class="form-row">
          <small id="duplicate_p"></small>
        </div>
      </div>
    </div>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="hebcal.min.js"></script>
    <script type="text/javascript">
      // Client ID and API key from the Developer Console
      var CLIENT_ID = '133534839514-6srelmk6gbv1h0abll2q70q614g8v93b.apps.googleusercontent.com';
      var API_KEY = 'AIzaSyB52Jhdt_cLZh9aXxVCAkr4WciMK0aVXaQ';

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = "https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly";
      const curYear = new Hebcal.HDate().year;

      var authorizeButton = document.getElementById('authorize_button');
      var signedin_div = document.getElementById('signedin_div');
      var signoutButton = document.getElementById('signout_button');
      var calendarSelect = document.getElementById('calendar_select');
      var fromYearSelect = document.getElementById('fromYear_select');
      var toYearSelect = document.getElementById('toYear_select');

      var fromYearP = document.getElementById('fromYear_p');
      var toYearP = document.getElementById('toYear_p');
      var deleteButton = document.getElementById('delete_button');
      var duplicateButton = document.getElementById('duplicate_button');
      var duplicateP = document.getElementById('duplicate_p');
      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeButton.style.display = 'none';
          // signoutButton.style.display = 'block';
          getCalendars().then(populateCalendars).then(function(){
            // calendar_select.onchange = populateFromYear;
            populateFromYear(fromYear_select,fromYear_p,-5,5);
            populateFromYear(toYear_select,toYear_p,-4,6);

            calendar_select.onchange = function() {
              fromYear_select.onchange();
              toYear_select.onchange();
            }

            delete_button.onclick = deleteTargetYearEvents;
            duplicate_button.onclick = duplicateHebrewEvents;

            signedin_div.style.display = 'block';
          });
        } else {
          authorizeButton.style.display = 'block';
          signedin_div.style.display = 'none';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }

      /**
       * Append a pre element to the body containing the given message
       * as its text node. Used to display the results of the API call.
       *
       * @param {string} message Text to be placed in pre element.
       */
      function appendPre(message) {
        var pre = document.getElementById('content');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

      /**
       * Print the summary and start datetime/date of the next ten events in
       * the authorized user's calendar. If no events are found an
       * appropriate message is printed.
       */

      function getStartOfEvent(event) {
        if (event.dateTime)
          return event.dateTime;
        return event.date;
      }

      function getSelectedValue(selectElement) {
        return selectElement.options[selectElement.selectedIndex].value;
      }

      function getCalendars() {
        return gapi.client.calendar.calendarList.list({
          'minAccessRole': "owner",
          'showDeleted': false,
          'showHidden': false,
          'maxResults': 10
        });
      }

      function populateCalendars(response) {
        const cals = response.result.items;
        if (cals.length > 0) {
          for (i = 0; i < cals.length; i++) {
            var cal = cals[i];
            var el = document.createElement("option");
            el.textContent = cal.summary;
            el.value = cal.id;
            calendar_select.appendChild(el);
          }
          // calendar_select.style.display = "block";
        }        
      }

      function getEventsByYear(hebYear) {
        var startDay = new Hebcal.HDate(1,7,hebYear);
        var endDay = new Hebcal.HDate(startDay).setFullYear(startDay.year+1);
        return gapi.client.calendar.events.list({
          'calendarId': getSelectedValue(calendar_select),
          'timeMin': (startDay.greg()).toISOString(),
          'timeMax': (endDay.greg()).toISOString(),
          'showDeleted': false,
          'singleEvents': true,
          'maxResults': 100,
          'orderBy': 'startTime'
        })
      }

      function countEventsFromYear(selector,paragraph) {
        getEventsByYear(getSelectedValue(selector))
        .then(function(response) {
            // paragraph.style.display = "block";
            paragraph.innerHTML = response.result.items.length + " events found";
        });
      }

      function populateFromYear(selector,paragraph,minDelta,maxDelta) {
        selector.style.display = "none";

        selector.options.length = 0;
        for (i = minDelta; i < maxDelta; i++) {
          var el = document.createElement("option");          
          el.textContent = curYear+i;
          el.value = curYear+i;
          selector.appendChild(el);
        }
        selector.selectedIndex = 5;
        selector.style.display = "block";
        selector.onchange = function() {
          paragraph.innerHTML = "loading...";
          countEventsFromYear(selector,paragraph);
        }
        countEventsFromYear(selector,paragraph);
      }

      function deleteTargetYearEvents() {
        getEventsByYear(getSelectedValue(toYear_select))
        .then(function(response) {
          var events = response.result.items;
          duplicateP.innerHTML = "Deleting target year events..."
          var batch = gapi.client.newBatch();
          if (events.length > 0) {
            for (i = 0; i < events.length; i++) {
              var event = events[i];
              // console.dir(event);
              batch.add(gapi.client.calendar.events.delete({
                'calendarId': getSelectedValue(calendar_select),
                'eventId': event.id
              }));
            }
            batch.then(function() {
              duplicateP.innerHTML = "Deleted succssfully";
              toYear_select.onchange();
            });
          }                     
        });
      }

      function nextHebOccurence(event,delta) {            
        var hd = new Hebcal.HDate(new Date(getStartOfEvent(event)));
        return hd.setFullYear(hd.year+delta).greg();
      }

      function duplicateHebrewEvents() {
       var opt = {
          calendarId: getSelectedValue(calendar_select),
          toYear: getSelectedValue(toYear_select),
          fromYear: getSelectedValue(fromYear_select)
       }
       duplicate_p.innerHTML = "Duplicating...";
       var delta = opt.toYear - opt.fromYear;
       getEventsByYear(opt.fromYear)
        .then(function(response) {
          var events = response.result.items;
          var batch = gapi.client.newBatch();
          if (events.length > 0) {
            for (i = 0; i < events.length; i++) {
              var event = events[i];
              batch.add(gapi.client.calendar.events.insert({
                'calendarId': opt.calendarId,
                'resource': {
                  'summary': event.summary,
                  'description': event.description,
                  'start' : {
                    'dateTime':nextHebOccurence(event.start,delta).toISOString()
                  },
                  'end' : {
                    'dateTime':nextHebOccurence(event.end,delta).toISOString()
                  }
                }
              }));
            }
            duplicate_p.innerHTML = "Duplicating "+events.length+" events...";
            batch.then(function() {
              duplicate_p.innerHTML = "Duplicated succssfully"
              toYear_select.onchange();
            });
          } else {
            duplicate_p.innerHTML = "No events found."
          }
        });
      }

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>
